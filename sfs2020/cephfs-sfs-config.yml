- hosts: all
  become: true
  vars:
    debuginfo_repo_name: "{{ 'baseos-debuginfo' if ansible_distribution == 'CentOS' else 'baseos-debug-rpms' if ansible_distribution == 'RedHat' else 'baseos-debuginfo' }}"
    crb_debuginfo_repo_name: "{{ 'crb-debuginfo' if ansible_distribution == 'CentOS' else 'codeready-builder-for-rhel-' ~ ansible_distribution_major_version ~ '-x86_64-debug-rpms' if ansible_distribution == 'RedHat' else 'crb-debuginfo' }}"
  tasks:
    - name: Fix baseos-debuginfo repository mirrors (prevent 404s)
      ansible.builtin.shell:
        cmd: |
          # The baseos-debuginfo repo is often broken on CentOS Stream 9 mirrors.
          # We fix it by:
          # 1. Pointing baseurl to the official vault/stream mirror
          # 2. Ensuring metalink is commented out if it's 404ing, or vice versa.
          # We do this with sed before any dnf calls to avoid metadata sync failures.
          
          REPO_FILE="/etc/yum.repos.d/centos.repo"
          if [ -f "$REPO_FILE" ]; then
            # Fix baseurl to official mirror
            sed -i '/^\[baseos-debuginfo\]/,/^\[/ s|^#\?baseurl=.*|baseurl=https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/debug/tree/|' "$REPO_FILE"
            # Comment out metalink as it is currently returning 404
            sed -i '/^\[baseos-debuginfo\]/,/^\[/ s|^metalink=|#metalink=|' "$REPO_FILE"
          fi
      when: ansible_distribution == 'CentOS' and false
      ignore_errors: yes

    - name: Ensure config-manager is available
      ansible.builtin.dnf:
        name: 'dnf-command(config-manager)'
        state: present
        update_cache: yes

    - name: Check if debuginfo repository is already enabled
      ansible.builtin.shell:
        cmd: dnf repolist enabled | grep -q "{{ debuginfo_repo_name }}"
      register: debuginfo_enabled
      failed_when: false
      changed_when: false

    - name: Enable debuginfo repository
      ansible.builtin.shell:
        cmd: dnf config-manager --set-enabled "{{ debuginfo_repo_name }}"
      when: debuginfo_enabled.rc != 0
      ignore_errors: yes

    - name: Check if CRB debuginfo repository is already enabled
      ansible.builtin.shell:
        cmd: dnf repolist enabled | grep -q "{{ crb_debuginfo_repo_name }}"
      register: crb_debuginfo_enabled
      failed_when: false
      changed_when: false

    - name: Enable CRB debuginfo repository
      ansible.builtin.shell:
        cmd: dnf config-manager --set-enabled "{{ crb_debuginfo_repo_name }}"
      when: crb_debuginfo_enabled.rc != 0
      ignore_errors: yes

    - name: Clean DNF cache
      ansible.builtin.command:
        cmd: dnf clean all

    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: Autoremove unneeded packages installed as dependencies
      ansible.builtin.dnf:
        autoremove: yes
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: Install systemtap and related packages
      ansible.builtin.dnf:
        name:
          - systemtap
          - systemtap-runtime
          - kernel-debuginfo
          - kernel-devel
          - kernel-debuginfo-common-x86_64
        enablerepo:
          - "{{ debuginfo_repo_name }}"
          - "{{ crb_debuginfo_repo_name }}"
        state: present
        update_cache: yes

    - name: Run stap-prep
      ansible.builtin.shell:
        cmd: stap-prep --enablerepo="{{ debuginfo_repo_name }},{{ crb_debuginfo_repo_name }}"
      ignore_errors: yes

    - name: Install perf tools
      ansible.builtin.dnf:
        name: "perf"
        state: latest

    - name: Create perf_users group
      ansible.builtin.group:
        name: perf_users
        state: present

    - name: Set group ownership of perf binary
      ansible.builtin.file:
        path: /usr/bin/perf
        group: perf_users

    - name: Set capabilities on perf binary
      community.general.capabilities:
        path: /usr/bin/perf
        capability: cap_perfmon,cap_sys_ptrace,cap_syslog=ep
        state: present

    - name: Set perf_event_paranoid to -1
      ansible.posix.sysctl:
        name: kernel.perf_event_paranoid
        value: '-1'
        state: present
        reload: yes

    - name: Install fio
      ansible.builtin.dnf:
        name: "fio"
        state: latest

    - name: Install iperf3
      ansible.builtin.dnf:
        name: "iperf3"
        state: latest

    - name: Install sysstat
      ansible.builtin.dnf:
        name: "sysstat"
        state: latest

    - name: Install net-tools
      ansible.builtin.dnf:
        name: "net-tools"
        state: latest

    - name: Install perl-open.noarch
      ansible.builtin.dnf:
        name: "perl-open.noarch"
        state: latest

    - name: Install tuned-adm tools
      ansible.builtin.dnf:
        name: "tuned"
        state: latest

- hosts: mons osds mdss clients
  become: true
  tasks:
    - name: Ensure EPEL and CRB are enabled
      ansible.builtin.shell:
        cmd: |
          dnf install -y epel-release
          if [ "{{ ansible_distribution }}" = "RedHat" ]; then
            dnf config-manager --set-enabled codeready-builder-for-rhel-{{ ansible_distribution_major_version }}-x86_64-rpms
          else
            dnf config-manager --set-enabled crb
          fi
      ignore_errors: yes

    - name: Install SPECstorage2020 dependencies (DNF)
      ansible.builtin.dnf:
        name:
          - python3-matplotlib
          - python3-dateutil
          - python3-numpy
          - python3-pyparsing
          - python3-six
          - python3-scipy
          - python3-openpyxl
          - python3-xlsxwriter
          - python3-cycler
          - python3-pyyaml
          - python3-pip
        state: present
        update_cache: yes

    - name: Install python3-pandas (DNF)
      ansible.builtin.dnf:
        name: python3-pandas
        state: present
      ignore_errors: yes
      register: pandas_dnf

    - name: Install python3-pandas (PIP fallback)
      ansible.builtin.pip:
        name: pandas
        executable: pip3
        state: present
      when: pandas_dnf is failed

    - name: Create /sfs2020 directory
      ansible.builtin.file:
        path: /sfs2020
        state: directory
        mode: '0755'

    - name: Copy SPECstorage2020-2529.tar to /sfs2020
      ansible.builtin.copy:
        src: SPECstorage2020-2529.tar
        dest: /sfs2020/SPECstorage2020-2529.tar
        mode: '0644'

    - name: Copy sfs_rc to /sfs2020
      ansible.builtin.copy:
        src: sfs_rc
        dest: /sfs2020/sfs_rc
        mode: '0644'

    - name: Copy sfs2020 python scripts to /sfs2020
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /sfs2020/
        mode: '0755'
      with_fileglob:
        - "*.py"

    - name: Install git
      ansible.builtin.dnf:
        name: git
        state: present

    - name: Clone FlameGraph repository
      ansible.builtin.git:
        repo: https://github.com/brendangregg/FlameGraph.git
        dest: /sfs2020/FlameGraph
        clone: yes
        update: yes

    - name: Untar SPECstorage2020
      ansible.builtin.unarchive:
        src: "/sfs2020/SPECstorage2020-2529.tar"
        dest: /sfs2020/
        remote_src: true

    - name: Run SM2020 install
      ansible.builtin.shell:
        cmd: cd /sfs2020/SPECstorage2020 && python3 SM2020 --install-dir=/SPEC2020
      ignore_errors: yes

    - name: Install pyupgrade
      ansible.builtin.shell:
        cmd: sudo pip3 install pyupgrade

    - name: Run pyupgrade on SM2020
      ansible.builtin.shell:
        cmd: pyupgrade --py3-plus /SPEC2020/SM2020
      ignore_errors: yes
      when: not (ansible_distribution == "RedHat" and ansible_distribution_major_version | int >= 9)

- hosts: mons
  become: true
  tasks:
    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Determine if firewalld is running
      ansible.builtin.set_fact:
        firewalld_running: "{{ 'firewalld.service' in ansible_facts.services and ansible_facts.services['firewalld.service'].state == 'running' }}"

    - name: Determine if iptables is running
      ansible.builtin.set_fact:
        iptables_running: "{{ 'iptables.service' in ansible_facts.services and ansible_facts.services['iptables.service'].state == 'running' }}"

    - name: Query firewalld for port range 5000-6000/tcp
      ansible.builtin.command: firewall-cmd --query-port=5000-6000/tcp
      register: fw_query
      failed_when: false
      changed_when: false
      when: firewalld_running | default(false)

    - name: Allow TCP port range 5000-6000 via firewalld (permanent)
      ansible.builtin.command: firewall-cmd --add-port=5000-6000/tcp --permanent
      when:
        - firewalld_running | default(false)
        - fw_query.rc is defined and fw_query.rc != 0

    - name: Reload firewalld after adding port range 5000-6000
      ansible.builtin.command: firewall-cmd --reload
      when:
        - firewalld_running | default(false)
        - fw_query.rc is defined and fw_query.rc != 0

    - name: Check if iptables already allows 5000-6000/tcp
      ansible.builtin.command: iptables -C INPUT -p tcp --dport 5000:6000 -j ACCEPT
      register: ipt_check
      failed_when: false
      changed_when: false
      when: iptables_running | default(false)

    - name: Add iptables rule to allow 5000-6000/tcp
      ansible.builtin.command: iptables -I INPUT -p tcp --dport 5000:6000 -j ACCEPT
      when:
        - iptables_running | default(false)
        - ipt_check.rc is defined and ipt_check.rc != 0

    - name: Persist iptables rules (best-effort)
      ansible.builtin.shell: iptables-save > /etc/sysconfig/iptables
      when:
        - iptables_running | default(false)
        - ipt_check.rc is defined and ipt_check.rc != 0
      ignore_errors: yes
